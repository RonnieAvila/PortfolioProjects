# SELECT *
# FROM PortfolioProject.Vaccinations
# ORDER BY 3,4

# Select data we are going to be using
SELECT 
  location, date, total_cases, new_cases, total_deaths, population
FROM
  PortfolioProject.Covid_Deaths
ORDER BY
  1,2

# Looking at Total_Cases vs Total_Deaths
#Shows likelihood of dying if you contract COVID in the USA
SELECT 
  location, date, total_cases, total_deaths, population
FROM
  PortfolioProject.Covid_Deaths
ORDER BY
  1,2

#Looking at Total Cases vs Population
# Shows what percentage of population got COVID 
SELECT 
  location, date, total_cases, population, (Total_cases/population)*100 AS Infection_percentage
FROM
  PortfolioProject.Covid_Deaths
WHERE
  location like '%United_States%'
ORDER BY
  1,2

# Looking at countries with highest infection rate compared with population

SELECT 
   location, population, MAX(total_cases) AS Highest_Infection_Count, MAX((total_cases/population))*100 AS Infection_percentage
FROM
  PortfolioProject.Covid_Deaths
# WHERE location like '%states%'
GROUP BY 
  location, population
ORDER BY
  Infection_percentage desc

# Showing countries with Highest Death Count per Population 
SELECT 
   location, MAX(cast(Total_deaths as int)) AS Total_Death_Count
FROM
  PortfolioProject.Covid_Deaths
# WHERE location like '%states%'
WHERE continent is not null
GROUP BY 
  location
ORDER BY
  Total_Death_Count desc

# LET'S BREAK THINGS DOWN BY CONTINENT

SELECT 
   continent, MAX(cast(Total_deaths as int)) AS Total_Death_Count
FROM
  PortfolioProject.Covid_Deaths
# WHERE location like '%states%'
WHERE continent is null
GROUP BY 
  continent
ORDER BY
  Total_Death_Count desc

# GLOBAL NUMEBERS
SELECT 
  date, SUM(new_cases) AS Total_Cases, SUM(cast(new_deaths as int)) AS Total_Deaths, SUM(cast(new_deaths as int))/SUM(New_Cases)*100 AS deathpercentage
FROM
  PortfolioProject.Covid_Deaths
# WHERE location like '%states%' 
WHERE continent is not null
GROUP BY 
  date
ORDER BY
  1,2

# See Total Deathpercentage for the whole world
SELECT 
  SUM(new_cases) AS Total_Cases, SUM(cast(new_deaths as int)) AS Total_Deaths, SUM(cast(new_deaths as int))/SUM(new_cases)*100 AS deathpercentage
FROM
  PortfolioProject.Covid_Deaths
# WHERE location like '%states%' 
WHERE continent is not null
--GROUP BY 
  --date
ORDER BY
1, 2,

#Looking at Total Population vs Vaccinations

SELECT
  dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(CAST(vac.new_vaccinations as int)) OVER (Partition by dea.Location Order by dea.location,
  dea.date) AS RollingPeople_Vaccinated
--,  (RollingPeople_Vaccinated/population)*100
FROM 
  PortfolioProject.Covid_Deaths dea
JOIN 
  PortfolioProject.Vaccinations vac 
  ON 
    dea.location = vac.location 
    and dea.date = vac.date
WHERE dea.continent is not null
ORDER BY 
  2, 3
  
# USE CTE
WITH PopvsVac AS (
  SELECT
  dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(CAST(vac.new_vaccinations as int)) OVER (Partition by dea.Location Order by dea.location,
  dea.date) AS RollingPeople_Vaccinated
FROM 
  PortfolioProject.Covid_Deaths dea
JOIN 
  PortfolioProject.Vaccinations vac 
  ON 
    dea.location = vac.location 
    and dea.date = vac.date
WHERE dea.continent is not null
--order by 2,3
 )
SELECT 
  *, (RollingPeople_Vaccinated/Population)*100
FROM 
  PopvsVac


#TempTable 
DROP TABLE IF EXISTS PortfolioProject.PercentPopulationVaccinated;
CREATE TABLE PortfolioProject.PercentPopulationVaccinated
(
Continent STRING(255),
Location STRING(255),
Date datetime,
Population numeric,
New_Vaccinations numeric,
RollingPeople_Vaccinated numeric
);

INSERT INTO PortfolioProject.PercentPopulationVaccinated

 SELECT
  dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(CAST(vac.new_vaccinations as int)) OVER (Partition by dea.Location Order by dea.location,
  dea.date) AS RollingPeople_Vaccinated
FROM 
  PortfolioProject.Covid_Deaths dea
JOIN 
  PortfolioProject.Vaccinations vac 
  ON 
    dea.location = vac.location 
    and dea.date = vac.date
WHERE dea.continent is not null
--order by 2,3
;
SELECT 
  *, (RollingPeople_Vacinated/Population)*100
FROM 
  PortfolioProject.PercentPopulationVaccinated



# Creating view to store data for visaulizations

CREATE VIEW PortfolioProject.PercentPopulationVaccinated AS 
 SELECT
  dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(CAST(vac.new_vaccinations as int)) OVER (Partition by dea.Location Order by dea.location,
  dea.date) AS RollingPeople_Vaccinated
FROM 
  PortfolioProject.Covid_Deaths dea
JOIN 
  PortfolioProject.Vaccinations vac 
  ON 
    dea.location = vac.location 
    and dea.date = vac.date
WHERE dea.continent is not null
#ORDER BY 2,3
;
SELECT 
  *
FROM PortfolioProject.PercentPopulationVaccinated
